# Main domain with frontend and API
mellocloud.net, www.mellocloud.net {
	encode gzip
	log

	# Security headers
	header {
		# Remove server info
		-Server
		# Security headers
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Proxy Portainer interface at /portainer (должно быть ПЕРВЫМ)
	handle_path /portainer* {
		# Remove /portainer prefix if Portainer expects clean paths
		uri strip_prefix /portainer
		reverse_proxy portainer:9000 {
			# Health check
			health_uri /
			health_interval 10s
			health_timeout 5s
		}
	}

	# Proxy API requests
	handle_path /api* {
		reverse_proxy backend:1337 {
			# Health check
			health_uri /health
			health_interval 10s
			health_timeout 5s
		}
	}

	# Proxy WebSocket requests (e.g., socket.io)
	handle_path /socket.io* {
		reverse_proxy backend:1337 {
			# Enable WebSocket support
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}
			# Health check
			health_uri /health
			health_interval 10s
			health_timeout 5s
		}
	}

	# Allow search engine indexing
	handle /robots.txt {
		header Content-Type text/plain
		respond "User-agent: *\nAllow: /" 200
	}

	# Proxy frontend (Vite) - должно быть ПОСЛЕДНИМ как fallback
	handle {
		reverse_proxy frontend:5173 {
			# Health check and failover
			health_uri /
			health_interval 10s
			health_timeout 5s
		}
	}
}

# Separate domain for API
api.mellocloud.net {
	encode gzip
	log

	# Security headers (less restrictive for API)
	header {
		-Server
		X-Content-Type-Options nosniff
	}

	# Proxy all requests to the backend
	reverse_proxy backend:1337 {
		# Health check
		health_uri /health
		health_interval 10s
		health_timeout 5s
	}

	# Allow search engine indexing
	handle /robots.txt {
		header Content-Type text/plain
		respond "User-agent: *\nAllow: /" 200
	}
}

# Redirect HTTP to HTTPS (optional — Caddy does it automatically)
http://mellocloud.net, http://www.mellocloud.net, http://api.mellocloud.net {
	redir https://{host}{uri}
}